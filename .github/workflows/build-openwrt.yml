name: Build OpenWrt

on:
  push:
    branches:
      - main
    paths:
      - 'configs/**'
      - 'scripts/**'
      - '.github/workflows/build-openwrt.yml'
  schedule:
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      target:
        description: 'ç¼–è¯‘ç›®æ ‡ (ç•™ç©ºåˆ™ç¼–è¯‘æ‰€æœ‰)'
        required: false
        default: ''
      clean_build:
        description: 'æ˜¯å¦å…¨é‡ç¼–è¯‘ (true/false)'
        required: false
        default: 'false'

env:
  REPO_URL: https://github.com/LiBwrt/openwrt-6.x
  REPO_BRANCH: main-nss
  FEEDS_CONF: feeds.conf.default
  TZ: Asia/Shanghai

jobs:
  matrix:
    name: ç”Ÿæˆç¼–è¯‘çŸ©é˜µ
    runs-on: ubuntu-22.04
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: æ£€æŸ¥å®šæ—¶ç¼–è¯‘å¼€å…³
        if: github.event_name == 'schedule'
        run: |
          if [ "${{ vars.ENABLE_SCHEDULE }}" != "true" ]; then
            echo "å®šæ—¶ç¼–è¯‘æœªå¼€å¯ï¼Œè·³è¿‡æœ¬æ¬¡æ„å»º"
            echo "å¦‚éœ€å¼€å¯ï¼Œè¯·åœ¨ä»“åº“ Settings â†’ Secrets and variables â†’ Actions â†’ Variables ä¸­"
            echo "æ–°å»ºå˜é‡ ENABLE_SCHEDULEï¼Œå€¼è®¾ä¸º true"
            exit 1
          fi

      - name: æ£€å‡ºä»“åº“
        uses: actions/checkout@v4

      - name: ç”Ÿæˆç›®æ ‡çŸ©é˜µ
        id: set-matrix
        run: |
          if [ -n "${{ github.event.inputs.target }}" ]; then
            echo "matrix={\"include\":[{\"config\":\"${{ github.event.inputs.target }}\"}]}" >> $GITHUB_OUTPUT
          else
            set -o pipefail
            files=$(printf '%s\n' configs/*.config 2>/dev/null | sed 's#.*/##; s/\.config$//')
            configs=$(echo "$files" | grep -v '^default$' || true)
            if [ -z "$configs" ]; then
              echo 'matrix={"include":[{"config":"default"}]}' >> $GITHUB_OUTPUT
            else
              matrix=$(echo "$configs" | jq -R . | jq -sc '{include: [.[] | {config: .}]}')
              echo "matrix=$matrix" >> $GITHUB_OUTPUT
            fi
          fi

  build:
    name: ç¼–è¯‘ ${{ matrix.config }}
    needs: matrix
    runs-on: ubuntu-22.04
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.matrix.outputs.matrix) }}

    steps:
      - name: æ£€å‡ºä»“åº“
        uses: actions/checkout@v4

      - name: é‡Šæ”¾ç£ç›˜ç©ºé—´
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: false
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          docker-images: true
          swap-storage: true

      - name: åˆå§‹åŒ–ç¼–è¯‘ç¯å¢ƒ
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          sudo -E apt-get -qq update
          sudo -E apt-get -qq full-upgrade -y
          sudo -E apt-get -qq install -y \
            ack antlr3 asciidoc autoconf automake autopoint binutils bison build-essential \
            bzip2 ccache cmake cpio curl device-tree-compiler fastjar flex gawk gettext \
            gcc-multilib g++-multilib git gperf haveged help2man intltool libc6-dev-i386 \
            libelf-dev libglib2.0-dev libgmp3-dev libltdl-dev libmpc-dev libmpfr-dev \
            libncurses5-dev libncursesw5-dev libreadline-dev libfuse-dev libssl-dev libtool \
            lrzsz genisoimage msmtp nano ninja-build p7zip p7zip-full patch pkgconf \
            python3 python3-pip libpython3-dev qemu-utils rsync scons squashfs-tools \
            subversion swig texinfo uglifyjs upx-ucl unzip vim wget xmlto xxd zlib1g-dev
          sudo -E apt-get -qq autoremove --purge
          sudo -E apt-get -qq clean
          sudo timedatectl set-timezone "$TZ"
          sudo mkdir -p /workdir
          sudo chown $USER:$GROUPS /workdir

      - name: å…‹éš†æºç 
        working-directory: /workdir
        run: |
          df -hT $PWD
          git clone --depth 1 --single-branch --branch $REPO_BRANCH $REPO_URL openwrt
          ln -sf /workdir/openwrt $GITHUB_WORKSPACE/openwrt

      - name: åŠ è½½è‡ªå®šä¹‰ feeds
        run: |
          if [ -f "feeds.conf.default" ]; then
            cp feeds.conf.default openwrt/feeds.conf.default
          fi
          if [ -f "scripts/customize.sh" ]; then
            chmod +x scripts/customize.sh
            cd openwrt && $GITHUB_WORKSPACE/scripts/customize.sh
          fi

      - name: æ›´æ–°å¹¶å®‰è£… feeds
        run: |
          cd openwrt
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: åŠ è½½é…ç½®æ–‡ä»¶
        run: |
          CONFIG_FILE="configs/${{ matrix.config }}.config"
          if [ -f "$CONFIG_FILE" ]; then
            cp "$CONFIG_FILE" openwrt/.config
            echo "å·²åŠ è½½é…ç½®: $CONFIG_FILE"
          elif [ -f "configs/default.config" ]; then
            cp "configs/default.config" openwrt/.config
            echo "å·²åŠ è½½é»˜è®¤é…ç½®"
          else
            echo "æœªæ‰¾åˆ°é…ç½®æ–‡ä»¶ï¼Œä½¿ç”¨é»˜è®¤é…ç½®"
          fi
          cd openwrt
          make defconfig

      - name: æ‰§è¡Œè‡ªå®šä¹‰è„šæœ¬ (ç¼–è¯‘å‰)
        env:
          MATRIX_CONFIG: ${{ matrix.config }}
        run: |
          DIY_SCRIPTS=$(ls $GITHUB_WORKSPACE/scripts/diy-*.sh 2>/dev/null | sort)
          if [ -z "$DIY_SCRIPTS" ]; then
            echo "âš ï¸ æœªæ‰¾åˆ°ä»»ä½• diy-*.sh è„šæœ¬ï¼Œè·³è¿‡"
          else
            for SCRIPT in $DIY_SCRIPTS; do
              echo "â–¶ï¸ æ‰§è¡Œ: $(basename $SCRIPT)"
              chmod +x "$SCRIPT"
              cd /workdir/openwrt && bash "$SCRIPT"
              echo "âœ… å®Œæˆ: $(basename $SCRIPT)"
            done
          fi

      - name: é‡æ–°åŒæ­¥é…ç½®
        run: |
          cd openwrt
          make defconfig

      - name: ä¸‹è½½ç¼–è¯‘ä¾èµ–
        id: download
        run: |
          cd openwrt
          make download -j$(nproc)
          find dl -size -1024c -exec ls -l {} \;
          find dl -size -1024c -exec rm -f {} \;

      - name: å¼€å§‹ç¼–è¯‘å›ºä»¶
        id: compile
        run: |
          cd openwrt
          echo -e "$(nproc) çº¿ç¨‹ç¼–è¯‘ä¸­..."
          make -j$(nproc) || make -j1 || make -j1 V=s
          echo "status=success" >> $GITHUB_OUTPUT

          grep '^CONFIG_TARGET.*DEVICE.*=y' .config | sed -r 's/.*DEVICE_(.*)=y/\1/' | grep -v '^ROOTFS$' > DEVICES
          if [ $(wc -l < DEVICES) -gt 1 ]; then echo "MultiDevice" > DEVICE_NAME; else cat DEVICES > DEVICE_NAME; fi
          [ -s DEVICE_NAME ] && echo "DEVICE_NAME=_$(cat DEVICE_NAME)" >> $GITHUB_ENV

          # Artifact ç”¨ï¼ˆåˆ†é’Ÿï¼‰
          echo "FILE_DATE=_$(date +"%Y%m%d%H%M")" >> $GITHUB_ENV

          # ç¾åŒ–æ–‡ä»¶å/æ ‡é¢˜ç”¨ï¼ˆåŒ—äº¬æ—¶é—´ï¼Œå¸¦ç§’ï¼‰
          echo "BUILD_TS=$(TZ=Asia/Shanghai date +"%Y%m%d_%H%M%S")" >> $GITHUB_ENV
          echo "BUILD_TS_HUMAN=$(TZ=Asia/Shanghai date +"%Y-%m-%d %H:%M:%S")" >> $GITHUB_ENV

      - name: æ£€æŸ¥ç£ç›˜ç©ºé—´
        if: (!cancelled())
        run: df -hT

      - name: æ•´ç†å›ºä»¶æ–‡ä»¶
        id: organize
        if: steps.compile.outputs.status == 'success'
        run: |
          cd openwrt/bin/targets/*/*
          KERNEL_VER=$(find -type f -name "*.manifest" -exec grep -oP '^kernel - \K.*?(?=~|-\d+-)' {} \; | head -1)
          [ -n "$KERNEL_VER" ] && echo "KERNEL_VER=$KERNEL_VER" >> $GITHUB_ENV
          rm -rf packages
          echo "FIRMWARE=$PWD" >> $GITHUB_ENV
          echo "status=success" >> $GITHUB_OUTPUT

      - name: ä¸Šä¼ å›ºä»¶åˆ° Artifacts
        uses: actions/upload-artifact@v4
        if: steps.organize.outputs.status == 'success'
        with:
          name: OpenWrt_firmware${{ env.DEVICE_NAME }}${{ env.FILE_DATE }}
          path: ${{ env.FIRMWARE }}
          retention-days: 7

      - name: ç”Ÿæˆç»Ÿä¸€é£æ ¼ Release æ–‡ä»¶åï¼ˆå‰ç¼€è‡ªåŠ¨è§£æï¼‰
        if: steps.organize.outputs.status == 'success'
        run: |
          set -euo pipefail
          cd "${{ env.FIRMWARE }}"

          CFG="${{ matrix.config }}"
          TS="${{ env.BUILD_TS }}"

          OUT="$PWD/release_pretty"
          mkdir -p "$OUT"

          # å…ƒæ•°æ®ç±»æ–‡ä»¶ï¼ˆä¿ç•™åŸåï¼‰
          for f in build.config config.buildinfo feeds.buildinfo version.buildinfo \
                   profiles.json *.manifest Packages.tar.gz; do
            [ -f "$f" ] && cp -f "$f" "$OUT/"
          done

          shopt -s nullglob

          for f in *; do
            [ -f "$f" ] || continue

            # åªå¤„ç†å›ºä»¶ï¼ˆåŒ…å« sysupgrade/factoryï¼‰
            case "$f" in
              *sysupgrade*|*factory*) ;;
              *) continue ;;
            esac

            base="$(basename "$f")"

            # 1) å‰ç¼€ï¼šä»åŸæ–‡ä»¶åå–ç¬¬ä¸€ä¸ª '-' å‰çš„éƒ¨åˆ†ï¼ˆå¦‚ libwrtï¼‰
            PREFIX="${base%%-*}"
            [ -z "$PREFIX" ] && PREFIX="firmware"

            # 2) ç±»å‹
            if [[ "$base" == *sysupgrade* ]]; then
              TYPE="sysupgrade"
            else
              TYPE="factory"
            fi

            # 3) æ‰©å±•åï¼ˆæ”¯æŒ img.gz / tar.gzï¼‰
            if [[ "$base" == *.img.gz ]]; then
              EXT="img.gz"
            elif [[ "$base" == *.tar.gz ]]; then
              EXT="tar.gz"
            else
              EXT="${base##*.}"
            fi

            # 4) è§£æ device
            # å¸¸è§ï¼š<prefix>-qualcommax-ipq60xx-<device>-squashfs-(factory|sysupgrade).<ext>
            DEVICE="unknown"
            if [[ "$base" =~ ^[^-]+-[^-]+-[^-]+-(.+)-squashfs-(factory|sysupgrade)\..+$ ]]; then
              DEVICE="${BASH_REMATCH[1]}"
            else
              DEVICE="$(echo "$base" | sed -E 's/^[^-]+-[^-]+-[^-]+-//; s/-squashfs-.*$//')"
              [ -z "$DEVICE" ] && DEVICE="unknown"
            fi

            NEW="${PREFIX}_${CFG}_${DEVICE}_${TYPE}_${TS}.${EXT}"
            cp -f "$f" "$OUT/$NEW"
          done

          cd "$OUT"
          sha256sum * > sha256sums_pretty.txt

          echo "PRETTY_DIR=$OUT" >> $GITHUB_ENV

      - name: ç”Ÿæˆ Release æ ‡ç­¾ä¸æ ‡é¢˜
        id: tag
        if: steps.compile.outputs.status == 'success'
        run: |
          SAFE_TAG="${{ matrix.config }}-$(TZ=Asia/Shanghai date +"%Y.%m.%d-%H-%M")"
          echo "release_tag=$SAFE_TAG" >> $GITHUB_OUTPUT

          PRETTY_NAME="R${{ env.BUILD_TS_HUMAN }} for ${{ matrix.config }}"
          echo "release_name=$PRETTY_NAME" >> $GITHUB_OUTPUT

          cd /workdir/openwrt
          COMMIT_HASH=$(git log -1 --format="%H" | cut -c1-8)
          COMMIT_AUTHOR=$(git log -1 --format="%an")
          COMMIT_DATE=$(git log -1 --format="%cd" --date=format:"%Y-%m-%d")
          COMMIT_MSG=$(git log -1 --format="%s")
          cd $GITHUB_WORKSPACE

          CONFIG="${{ matrix.config }}"
          CFG_FILE="configs/${CONFIG}.cfg"
          [ -f "$CFG_FILE" ] || CFG_FILE="configs/default.cfg"

          DEFAULT_IP="192.168.100.1"
          DEFAULT_THEME="æœªè®¾ç½®"
          DESC="This is OpenWrt Firmware for ${CONFIG}"
          WIFI_SSID=""
          WIFI_PASSWORD=""
          NOWIFI=""
          if [ -f "$CFG_FILE" ]; then
            _ip=$(grep -m1 '^DEFAULT_IP=' "$CFG_FILE" | cut -d= -f2 | tr -d ' ')
            _theme=$(grep -m1 '^DEFAULT_THEME=' "$CFG_FILE" | cut -d= -f2 | tr -d ' ')
            _desc=$(grep -m1 '^DESC=' "$CFG_FILE" | cut -d= -f2-)
            _ssid=$(grep -m1 '^WIFI_SSID=' "$CFG_FILE" | cut -d= -f2-)
            _password=$(grep -m1 '^WIFI_PASSWORD=' "$CFG_FILE" | cut -d= -f2-)
            _nowifi=$(grep -m1 '^NOWIFI=' "$CFG_FILE" | cut -d= -f2 | tr -d ' ')
            [ -n "$_ip" ]       && DEFAULT_IP="$_ip"
            [ -n "$_theme" ]    && DEFAULT_THEME="$_theme"
            [ -n "$_desc" ]     && DESC="$_desc"
            [ -n "$_ssid" ]     && WIFI_SSID="$_ssid"
            [ -n "$_password" ] && WIFI_PASSWORD="$_password"
            [ -n "$_nowifi" ]   && NOWIFI="$_nowifi"
          fi

          {
            echo "$DESC"
            echo ""
            echo "---"
            echo ""
            echo "## ğŸ“¦ å›ºä»¶ä¿¡æ¯"
            echo ""
            echo "| é¡¹ç›® | å†…å®¹ |"
            echo "|------|------|"
            echo "| ğŸ–¥ï¸ å¹³å° | \`${CONFIG}\` |"
            echo "| ğŸ”— å›ºä»¶æºç  | [$REPO_URL]($REPO_URL) |"
            echo "| ğŸŒ¿ æºç åˆ†æ”¯ | \`$REPO_BRANCH\` |"
            echo "| ğŸŒ é»˜è®¤åœ°å€ | \`${DEFAULT_IP}\` |"
            echo "| ğŸ¨ é»˜è®¤ä¸»é¢˜ | \`${DEFAULT_THEME}\` |"
            echo "| ğŸ”‘ é»˜è®¤å¯†ç  | æ—  |"
            if [ "$NOWIFI" = "true" ]; then
              echo "| ğŸ“¶ WiFi | æ— çº¿ç‰ˆæœ¬ä¸å« WiFi |"
            elif [ -n "$WIFI_SSID" ]; then
              echo "| ğŸ“¶ WiFi åç§° | \`${WIFI_SSID}\` |"
              echo "| ğŸ” WiFi å¯†ç  | \`${WIFI_PASSWORD}\` |"
            fi
            echo ""
            echo "## ğŸ“‹ ä»£ç ä¿¡æ¯"
            echo ""
            echo "| é¡¹ç›® | å†…å®¹ |"
            echo "|------|------|"
            echo "| ğŸ‘¤ ä½œè€… | ${COMMIT_AUTHOR} |"
            echo "| ğŸ“… æ—¶é—´ | ${COMMIT_DATE} |"
            echo "| ğŸ“ å†…å®¹ | ${COMMIT_MSG} |"
            echo "| #ï¸âƒ£ Hash | \`${COMMIT_HASH}\` |"
            echo ""
            echo "> ç¼–è¯‘æ—¶é—´: ${{ env.BUILD_TS_HUMAN }} (åŒ—äº¬æ—¶é—´)"
            echo ""
            echo "## ğŸ“ Release æ–‡ä»¶å‘½åè§„åˆ™"
            echo ""
            echo "- å›ºä»¶ï¼š\`<prefix>_${CONFIG}_<device>_<factory|sysupgrade>_${{ env.BUILD_TS }}.<ext>\`"
            echo "- æ ¡éªŒï¼š\`sha256sums_pretty.txt\`ï¼ˆå¯¹åº” Release å†…æ–‡ä»¶åï¼‰"
          } > release.txt

          echo "status=success" >> $GITHUB_OUTPUT

      - name: å‘å¸ƒåˆ° Release
        uses: softprops/action-gh-release@v2.4.2
        if: steps.tag.outputs.status == 'success'
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          tag_name: ${{ steps.tag.outputs.release_tag }}
          name: ${{ steps.tag.outputs.release_name }}
          body_path: release.txt
          files: ${{ env.PRETTY_DIR }}/*

      - name: åˆ é™¤æ—§çš„ Releases
        uses: dev-drprasad/delete-older-releases@v0.3.4
        if: steps.compile.outputs.status == 'success'
        with:
          keep_latest: 5
          delete_tags: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: åˆ é™¤æ—§çš„ Workflow è¿è¡Œè®°å½•
        uses: Mattraks/delete-workflow-runs@v2
        if: steps.compile.outputs.status == 'success'
        with:
          retain_days: 1
          keep_minimum_runs: 3